// libs/backend/prisma-client/prisma/schema.prisma

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ==========================================
// 0. ENUMS
// ==========================================

enum UserRole {
  OWNER
  ADMIN
  SALES_MANAGER
  PROJECT_MANAGER
  FRONTSELL_AGENT
  UPSELL_AGENT
}

enum InvitationStatus {
  PENDING
  ACCEPTED
  EXPIRED
  CANCELLED
}

enum LeadStatus {
  NEW
  CONTACTED
  PROPOSAL
  CLOSED
}

enum SaleStatus {
  PENDING
  ACTIVE
  COMPLETED
  CANCELLED
}

enum InvoiceStatus {
  UNPAID
  PAID
  OVERDUE
}

enum LeadActivityType {
  STATUS_CHANGE
  NOTE
  ASSIGNMENT_CHANGE
  CONVERSION
  CREATED
}

enum TransactionStatus {
  PENDING
  SUCCESS
  FAILED
  REFUNDED
}

enum TransactionType {
  ONE_TIME
  RECURRING
  REFUND
}

// ==========================================
// 1. MULTI-TENANCY CORE
// ==========================================

model Organization {
  id            String   @id @default(uuid())
  name          String   // e.g., "Madcom Digital"
  subscription  String   @default("FREE") // "STARTER", "ENTERPRISE"

  brands        Brand[]
  users         User[]
  leads         Lead[]
  clients       Client[]
  sales         Sale[]
  invitations   Invitation[]

  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
}

model Brand {
  id            String   @id @default(uuid())
  name          String   // e.g., "The Pulp House"
  domain        String?  @unique

  // Branding Assets
  logoUrl       String?
  colors        Json?

  organizationId String
  organization   Organization @relation(fields: [organizationId], references: [id])

  leads          Lead[]
  clients        Client[]
  sales          Sale[]
  emailAliases   EmailAlias[]

  members        BrandAccess[]

  @@index([organizationId])
}

// ==========================================
// 2. IAM & AGENT MANAGEMENT
// ==========================================

model User {
  id            String   @id @default(uuid())
  email         String   @unique
  password      String   // Hashed
  name          String
  role          UserRole @default(FRONTSELL_AGENT)

  // Profile Fields
  avatarUrl     String?
  jobTitle      String?
  phone         String?
  bio           String?
  isActive      Boolean  @default(true) // For soft delete

  organizationId String
  organization   Organization @relation(fields: [organizationId], references: [id])

  // Permissions & Access
  accessScope   BrandAccess[]
  emailConfig   UserEmailConfig? // Gmail Integration

  assignedLeads Lead[]
  leadActivities LeadActivity[]

  // Refresh Token (for JWT)
  refreshToken      String?

  // Password Reset
  resetPasswordToken   String?   @unique
  resetPasswordExpires DateTime?

  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  @@index([organizationId, email])
}

model BrandAccess {
  id        String @id @default(uuid())
  userId    String
  brandId   String
  role      String // "VIEWER", "EDITOR", "ADMIN"

  user      User   @relation(fields: [userId], references: [id])
  brand     Brand  @relation(fields: [brandId], references: [id])

  @@unique([userId, brandId]) // User can't have duplicate roles for same brand
}

model Invitation {
  id            String           @id @default(uuid())
  email         String
  role          UserRole         @default(FRONTSELL_AGENT)
  token         String           @unique // Unique token for invitation link
  status        InvitationStatus @default(PENDING)
  expiresAt     DateTime

  organizationId String
  organization   Organization @relation(fields: [organizationId], references: [id])

  invitedById   String // The user who sent the invitation

  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  @@index([organizationId, email])
  @@index([token])
}

// ==========================================
// 3. EMAIL INTEGRATION (Gmail Aliases)
// ==========================================

model UserEmailConfig {
  id            String   @id @default(uuid())
  userId        String   @unique
  user          User     @relation(fields: [userId], references: [id])

  primaryEmail  String   // "mark@publishing.com"
  accessToken   String   // Encrypted
  refreshToken  String   // Encrypted

  aliases       EmailAlias[]
}

model EmailAlias {
  id            String   @id @default(uuid())
  email         String   // "mark@urbanquill.com"
  displayName   String?  // "Mark - Urban Quill"

  configId      String
  config        UserEmailConfig @relation(fields: [configId], references: [id])

  linkedBrandId String?
  linkedBrand   Brand?   @relation(fields: [linkedBrandId], references: [id])
}

// ==========================================
// 4. BUSINESS FLOW (Sales Engine)
// ==========================================

model Lead {
  id            String     @id @default(uuid())
  title         String     // "Website Inquiry - John"
  status        LeadStatus @default(NEW)
  source        String?    // "PPC", "FB_ADS"
  data          Json?      // Flexible Form Data

  brandId       String
  brand         Brand      @relation(fields: [brandId], references: [id])

  organizationId String
  organization   Organization @relation(fields: [organizationId], references: [id])

  assignedToId  String?
  assignedTo    User?      @relation(fields: [assignedToId], references: [id])

  convertedClientId String? @unique // Link if converted

  activities    LeadActivity[]

  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  @@index([organizationId, brandId, status]) // Performance Index for Dashboard
}

model LeadActivity {
  id        String           @id @default(uuid())
  type      LeadActivityType
  data      Json             // Stores context based on type

  leadId    String
  lead      Lead             @relation(fields: [leadId], references: [id], onDelete: Cascade)

  userId    String           // Who performed the action
  user      User             @relation(fields: [userId], references: [id])

  createdAt DateTime         @default(now())

  @@index([leadId, createdAt])
}

model Client {
  id            String   @id @default(uuid())
  email         String
  password      String   // Portal Access (hashed)
  companyName   String
  contactName   String?
  phone         String?
  address       String?
  notes         String?

  brandId       String
  brand         Brand    @relation(fields: [brandId], references: [id])

  organizationId String
  organization   Organization @relation(fields: [organizationId], references: [id])

  sales         Sale[]

  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  @@unique([email, organizationId])
}

model Sale {
  id            String     @id @default(uuid())
  totalAmount   Decimal    @db.Decimal(10, 2)
  status        SaleStatus @default(PENDING)
  currency      String     @default("USD")
  description   String?

  // Authorize.net fields
  customerProfileId String?
  paymentProfileId  String?
  subscriptionId    String?

  clientId      String
  client        Client   @relation(fields: [clientId], references: [id])

  brandId       String
  brand         Brand    @relation(fields: [brandId], references: [id])

  organizationId String
  organization   Organization @relation(fields: [organizationId], references: [id])

  invoices      Invoice[]
  transactions  PaymentTransaction[]

  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  @@index([organizationId, brandId, status])
  @@index([clientId])
  @@index([subscriptionId])
}

model Invoice {
  id            String        @id @default(uuid())
  invoiceNumber String        @unique
  amount        Decimal       @db.Decimal(10, 2)
  dueDate       DateTime
  status        InvoiceStatus @default(UNPAID)
  pdfUrl        String?
  notes         String?

  saleId        String
  sale          Sale          @relation(fields: [saleId], references: [id])

  transactions  PaymentTransaction[]

  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  @@index([saleId])
  @@index([status, dueDate])
}

model PaymentTransaction {
  id              String            @id @default(uuid())
  transactionId   String?           // Authorize.net reference
  type            TransactionType
  amount          Decimal           @db.Decimal(10, 2)
  status          TransactionStatus @default(PENDING)
  responseCode    String?
  responseMessage String?

  saleId          String
  sale            Sale              @relation(fields: [saleId], references: [id])

  invoiceId       String?
  invoice         Invoice?          @relation(fields: [invoiceId], references: [id])

  createdAt       DateTime          @default(now())

  @@index([saleId])
  @@index([transactionId])
}

// ==========================================
// 5. RELIABILITY (Transactional Outbox)
// ==========================================

model OutboxEvent {
  id        String   @id @default(uuid())
  eventType String   // "ORDER_CREATED", "LEAD_ASSIGNED"
  payload   Json
  status    String   @default("PENDING") // "PROCESSING", "COMPLETED", "FAILED"
  createdAt DateTime @default(now())

  @@index([status, createdAt]) // Worker will poll PENDING events fast
}
